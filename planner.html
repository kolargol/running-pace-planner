<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Running Pace Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://saturn.onefellow.com/cdn/c0x0/assets/css/bootstrap4.min.css" integrity="sha256-YLGeXaapI0/5IgZopewRJcFXomhRMlYYjugPLSyNjTY=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://saturn.onefellow.com/cdn/c0x0/assets/css/animate.css" integrity="sha256-a1Uaqb5jk0rXVEBZ70Y/fVgDG2AVmwW4nE2AGE4EVMU=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://saturn.onefellow.com/cdn/c0x0/assets/css/extra.css" integrity="sha256-KRJaxSXpahH1gVS+xTIp1RZq/+J32VlpbiacKugs18k=" crossorigin="anonymous">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div class="container mt-4 animated fadeIn">
    <h1 class="bg-light text-dark py-3">Running Pace Planner</h1>
    <p>
The Running Pace Planner assists runners in planning their pacing throughout races with various pacing zones. It calculates the estimated finishing time and generates a race plan. This calculator was developed as an experiment to determine if AI can create reliable code. The model employed here is GPT-4, and the code was primarily generated by AI under human supervision.
    </p>
    <div class="input-group mb-4">
        <div class="input-group-prepend">
        <span style="width: 140px;" class="input-group-text border-secondary" id="basic-addon1">Distance in km:</span>
        </div>
        <input class="form-control border-secondary" type="number" id="distance" value="21.1" step="0.1" min="0.1" max="200" onchange="updateLiveResults()">
    </div>

    <div class="form-row">
        <input type="number" id="pace-section-start" step="0.1" min="0" max="200" readonly hidden>
        <div class="col">
            <div class="input-group mb-4">
                <div class="input-group-prepend">
                    <span style="width: 200px;" class="input-group-text border-secondary">Pace segment ends at:</span>
                </div>

            <input class="form-control border-secondary" type="number" id="pace-section-end" step="0.1" min="0.1" max="200" placeholder="segment in km">
            </div>
        </div>

         <div class="col">
             <div class="input-group mb-4">
                 <div class="input-group-prepend">
                     <span style="width: 150px;" class="input-group-text border-secondary">Target pace:</span>
                 </div>

            <input class="form-control border-secondary" type="number" id="pace" step="0.01" min="0" max="30" placeholder="Minutes.Seconds" onblur="validatePace(this)">
            </div>
        </div>

        <div class="col">
            <button class="btn btn-primary" type="button" onclick="addPaceSectionFromInput()">Add Pace Segment</button>
            <button class="btn btn-danger" type="button" onclick="reloadPage()">Reset all data</button>
        </div>

    </div>
    <br>
    Course Planning Progress:
    <div class="progress" style="height: 30px;">
        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div class="d-flex justify-content-center align-items-center">
        <div class="inner-div" id="chart-container" style="width: 800px; height: 400px;"></div>
    </div>

    <div class="card-group">
        <div class="card" id="live-results"></div>
        <div class="card" id="pace-summary"></div>
    </div>

    <script>
        let chartInstance;
        let paceSections = [];

        function updatePaceSummary() {
            const totalDistance = parseFloat(document.getElementById("distance").value);
            let totalSectionDistance = 0;

            paceSections.forEach((section) => {
                totalSectionDistance += (section.end - section.start);
            });

            const remainingDistance = (totalDistance - totalSectionDistance).toFixed(2);
            let paceSummaryText = '<div class="card-header">Pace segments (<em>length and expected pace</em>)</div><ul>';

            paceSections.forEach((section, index) => {
                paceSummaryText += `<li><b>Segment ${index + 1}</b> (<em>${section.start} km to ${section.end} km</em>), <b>length</b> ${section.end - section.start} km <b>pace at</b> ${section.pace} min/km</li>`;
            });

            document.getElementById("pace-summary").innerHTML = paceSummaryText;
        }

        function updateChartFromSelect() {
            const selectedIndex = document.getElementById("pace-select").selectedIndex;
            if (selectedIndex === -1) return;
            if (selectedIndex === 0) {
                document.getElementById("pace-section-start").value = "";
                document.getElementById("pace-section-end").value = "";
                document.getElementById("pace").value = "";
                return;
            }

            if (!chartInstance || !chartInstance.data) {
                console.error("Chart instance is not defined or does not have data property.");
                return;
            }

            const selectedSection = paceSections[selectedIndex - 1];
            const chartData = chartInstance.data[0];
            const traceIndex = chartData.x.findIndex((x) => x === selectedSection.end);
            Plotly.update('chart-container', { selectedpoints: null });
            Plotly.update('chart-container', { x: [chartData.x.slice(0, traceIndex + 1)], y: [chartData.y.slice(0, traceIndex + 1)] });
            document.getElementById("pace-section-start").value = selectedSection.start;
            document.getElementById("pace-section-end").value = selectedSection.end;
            document.getElementById("pace").value = selectedSection.pace;
        }

function updateLiveResults() {
    const totalDistance = parseFloat(document.getElementById("distance").value);
    let totalTime = 0;
    let totalSectionDistance = 0;
    
    paceSections.forEach((section) => {
        const paceString = String(section.pace);
        const paceParts = paceString.split('.');
        //const paceInMinutes = parseFloat(paceParts[0]) + parseFloat(paceParts[1]) / 60;
        const paceInMinutes = parseFloat(paceParts[0]) + (isNaN(parseFloat(paceParts[1])) ? 0 : parseFloat(paceParts[1]) / 60);
        totalTime += (section.end - section.start) * paceInMinutes;
        totalSectionDistance += (section.end - section.start);
    });

    const remainingDistance = totalDistance - totalSectionDistance;
    const lastSectionPaceString = String(paceSections[paceSections.length - 1].pace);
    const lastSectionPaceParts = lastSectionPaceString.split('.');
    //const lastSectionPaceInMinutes = parseFloat(lastSectionPaceParts[0]) + parseFloat(lastSectionPaceParts[1]) / 60;
    const lastSectionPaceInMinutes = parseFloat(lastSectionPaceParts[0]) + (isNaN(parseFloat(lastSectionPaceParts[1])) ? 0 : parseFloat(lastSectionPaceParts[1]) / 60);
    totalTime += remainingDistance * lastSectionPaceInMinutes;
    
    const hours = Math.floor(totalTime / 60);
    const minutes = Math.floor(totalTime % 60);
    const seconds = Math.round(((totalTime % 60) % 1) * 60);
      
    const averagePace = totalTime / totalDistance;
    const avgPaceMinutes = Math.floor(averagePace);
    const avgPaceSeconds = Math.round((averagePace % 1) * 60);
    const avgPaceString = `${avgPaceMinutes}m ${avgPaceSeconds}s`;

    const timeString = `${hours}h ${minutes}m ${seconds}s`;
    const remainingDistanceString = remainingDistance.toFixed(1);
    document.getElementById("live-results").innerHTML = `
      <div class="card-header">Predicted race results</div>
      <div class="card-body">
      <p class="card-text">
        <b>Finish Time:</b> ${timeString}<br><b>Average Pace:</b> ${avgPaceString} min/km<br><b>Remaining Distance:</b> ${remainingDistanceString} km</p>
      </div>
`;
}


function autofillPaceSectionStart() {
    const lastSectionEnd = paceSections[paceSections.length - 1].end;
    document.getElementById("pace-section-start").value = lastSectionEnd;
}

function addPaceSectionFromInput() {
    const paceSectionEnd = parseFloat(document.getElementById("pace-section-end").value);
    const pace = parseFloat(document.getElementById("pace").value);

    if (isNaN(paceSectionEnd) || isNaN(pace)) {
        alert("Please enter a valid distance and pace.");
        return;
    }

    const lastSectionEnd = paceSections.length > 0 ? paceSections[paceSections.length - 1].end : 0;
    const distance = paceSectionEnd - lastSectionEnd;


    if (paceSections.length > 0 && paceSectionEnd <= lastSectionEnd) {
        alert("Cannot add a Pace Section in the past. Please enter a valid Pace Section End.");
        return;
    }


    paceSections.push({ start: lastSectionEnd, end: paceSectionEnd, pace });

    const option = document.createElement("option");
    option.text = `Pace Section ${paceSections.length}`;

    updateLiveResults();
    updatePaceSummary();
    updateChartData();
    updateProgressBar();
}

function updateChartData() {
    const chartData = chartInstance.data[0];

    chartData.x = [];
    chartData.y = [];

    paceSections.forEach((section) => {
        // Add the start point of the pace section
        chartData.x.push(section.start);
        chartData.y.push(section.pace);

        // Add the end point of the pace section
        chartData.x.push(section.end);
        chartData.y.push(section.pace);
    });

    Plotly.redraw('chart-container');
}


function autofillPaceSectionStart() {
    const lastSectionEnd = paceSections[paceSections.length - 1].end;
    document.getElementById("pace-section-start").value = lastSectionEnd;
}

function lockPreviousSection() {
    const lastIndex = paceSections.length - 1;
    if (lastIndex >= 0) {
        document.getElementById("pace-section-end").readOnly = true;
    }
}




        function deletePaceSection() {
            const selectedIndex = document.getElementById("pace-select").selectedIndex;
            if (selectedIndex === -1 || selectedIndex === 0) return;

            paceSections.splice(selectedIndex - 1, 1);

            const chartData = chartInstance.data[0];
            const traceIndex = chartData.x.findIndex((x) => x === chartData.x[chartData.x.length - 1]);
            Plotly.update('chart-container', { selectedpoints: null });
            Plotly.update('chart-container', { x: [chartData.x.slice(0, traceIndex + 1)], y: [chartData.y.slice(0, traceIndex + 1)] });
            chartData.x.splice(traceIndex + 1);
            chartData.y.splice(traceIndex + 1);

            document.getElementById("pace-select").remove(selectedIndex);

            updateLiveResults();
            updatePaceSummary();
        }

document.addEventListener('DOMContentLoaded', function () {
    const chartContainer = document.getElementById('chart-container');
    const chartData = [{ x: [0], y: [0], mode: 'lines+markers', marker: { size: 8 } }];
    const chartLayout = { xaxis: { title: 'Distance (km)' }, yaxis: { title: 'Pace (min/km)' }, showlegend: false };
    Plotly.newPlot('chart-container', chartData, chartLayout).then((chart) => {
        chartInstance = chart;
    });

    chartContainer.on('plotly_click', function (event) {
        const chartData = chartInstance.data[0];
        const selectedIndex = event.points[0].pointIndex;
        const selectedX = chartData.x[selectedIndex];
        const selectedY = chartData.y[selectedIndex];

        const paceSectionIndex = paceSections.findIndex((section) => {
            return section.start <= selectedX && section.end >= selectedX;
        });

        if (paceSectionIndex === -1) {
            document.getElementById("pace-section-start").value = "";
            document.getElementById("pace-section-end").value = "";
            document.getElementById("pace").value = "";
            return;
        }

        const selectedSection = paceSections[paceSectionIndex];
        document.getElementById("pace-section-start").value = selectedSection.start;
        document.getElementById("pace-section-end").value = selectedSection.end;
        document.getElementById("pace").value = selectedSection.pace;
        document.getElementById("pace-select").selectedIndex = paceSectionIndex + 1;
    });
});

function updateProgressBar() {
    const progressBar = document.getElementById("progress-bar");
    
    // Get the total distance from the input field
    const totalDistanceInput = document.getElementById("distance");
    const totalDistance = parseFloat(totalDistanceInput.value);
    
    if (paceSections.length === 0 || isNaN(totalDistance) || totalDistance === 0) {
        progressBar.style.width = "0%";
        progressBar.setAttribute("aria-valuenow", 0);
        return;
    }

    const lastSectionEnd = paceSections[paceSections.length - 1].end;
    const remainingDistance = totalDistance - lastSectionEnd;
    const percentage = ((totalDistance - remainingDistance) / totalDistance) * 100;

    progressBar.style.width = `${percentage}%`;
    progressBar.setAttribute("aria-valuenow", percentage);
    progressBar.textContent = `${percentage.toFixed(1)}%`;
}





        function resetAllData() {
            // Reset inputs
            document.getElementById("distance").value = "21.1";
            document.getElementById("pace-section-start").value = "";
            document.getElementById("pace-section-end").value = "";
            document.getElementById("pace").value = "";

            // Remove all pace sections
            paceSections = [];
            const paceSelect = document.getElementById("pace-select");
            while (paceSelect.length > 1) {
                paceSelect.remove(1);
            }

            // Clear pace summary
            document.getElementById("pace-summary").innerHTML = "";

            // Reset chart data
            const chartData = chartInstance.data[0];
            chartData.x = [0];
            chartData.y = [0];
            Plotly.redraw('chart-container');

            // Update live results
            updateLiveResults();
        }

        function validatePace(inputElement) {
            const pattern = /^([1-9]|1[0-2])(\.([0-5][0-9]|[0-9]))?$/;
            const inputValue = inputElement.value;

            if (!pattern.test(inputValue) && inputValue !== "") {
                inputElement.setCustomValidity("Please enter a valid pace in the format X.Y, where X is between 1 and 12 and Y is between 0 and 59.");
                inputElement.reportValidity();
                } else {
                inputElement.setCustomValidity("");
            }
        }

        function reloadPage() {
            location.reload();
        }
    </script>
  <footer class="bg-light text-dark py-3">
    <div class="container">
      <div class="row">
        <div class="col">
          <p class="text-center">&copy; 2023 The AI. Made with open-source. Use at your own risk.</p>
        </div>
      </div>
    </div>
  </footer>
  </div>
</body>
</html>

